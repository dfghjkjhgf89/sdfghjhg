{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>üë• –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Telegram ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                    <th>–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏</th>
                    <th>–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th style="min-width: 200px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user_data in users_data %}
                <tr>
                    <td>{{ user_data.user.id }}</td>
                    <td>
                        <a href="#" class="copy-text" data-text="{{ user_data.user.telegram_id }}"
                            data-bs-toggle="tooltip" title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                            {{ user_data.user.telegram_id }}
                            <i class="fas fa-copy ml-1"></i>
                        </a>
                    </td>
                    <td>{{ user_data.user.telegram_username or '–ù–µ—Ç' }}</td>
                    <td>{{ user_data.user.email }}</td>
                    <td>{{ user_data.user.registration_date.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        {% if user_data.autopayment_enabled %}
                        <span class="badge badge-success">‚úÖ –í–∫–ª—é—á–µ–Ω—ã</span>
                        {% else %}
                        <span class="badge badge-danger">‚ùå –û—Ç–∫–ª—é—á–µ–Ω—ã</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user_data.subscription_end %}
                        {{ user_data.subscription_end.strftime('%Y-%m-%d %H:%M') }}
                        <span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% else %}
                        <span class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user_data.user.is_active %}
                        <span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% else %}
                        <span class="badge badge-danger">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group">
                            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                            <a href="{{ url_for('user_details', user_id=user_data.user.id) }}"
                                class="btn btn-sm btn-info" data-bs-toggle="tooltip" title="–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
                                <i class="fas fa-info-circle"></i>
                            </a>

                            <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å -->
                            <a href="{{ url_for('edit_user', user_id=user_data.user.id) }}"
                                class="btn btn-sm btn-primary" data-bs-toggle="tooltip"
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                                <i class="fas fa-edit"></i>
                            </a>

                            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π -->
                            <a href="{{ url_for('manage_subscription', user_id=user_data.user.id) }}"
                                class="btn btn-sm btn-warning" data-bs-toggle="tooltip" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π">
                                <i class="fas fa-clock"></i>
                            </a>

                            <!-- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                            <button type="button" class="btn btn-sm btn-success send-message-btn" data-bs-toggle="modal"
                                data-bs-target="#messageModal" data-user-id="{{ user_data.user.id }}"
                                data-username="{{ user_data.user.telegram_username }}" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
                                <i class="fas fa-envelope"></i>
                            </button>

                            <!-- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ -->
                            <form action="{{ url_for('toggle_user_active', user_id=user_data.user.id) }}" method="POST"
                                class="d-inline">
                                <button type="submit"
                                    class="btn btn-sm {% if user_data.user.is_active %}btn-danger{% else %}btn-success{% endif %}"
                                    data-bs-toggle="tooltip"
                                    title="{% if user_data.user.is_active %}–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å{% else %}–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å{% endif %}">
                                    {% if user_data.user.is_active %}
                                    <i class="fas fa-ban"></i>
                                    {% else %}
                                    <i class="fas fa-check"></i>
                                    {% endif %}
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('send_user_message') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="user_id" id="messageUserId">
                    <div class="mb-3">
                        <label for="messageText" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è <span
                                id="messageUsername"></span></label>
                        <textarea class="form-control" id="messageText" name="message" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram ID
    document.querySelectorAll('.copy-text').forEach(element => {
        element.addEventListener('click', function (e) {
            e.preventDefault();
            const text = this.dataset.text;
            navigator.clipboard.writeText(text).then(() => {
                const icon = this.querySelector('i');
                icon.classList.remove('fa-copy');
                icon.classList.add('fa-check');
                setTimeout(() => {
                    icon.classList.remove('fa-check');
                    icon.classList.add('fa-copy');
                }, 2000);
            });
        });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.querySelectorAll('.send-message-btn').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.dataset.userId;
            const username = this.dataset.username;
            document.getElementById('messageUserId').value = userId;
            document.getElementById('messageUsername').textContent = username || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        });
    });
</script>
{% endblock %}

{% endblock %}